name: "Build: Odoo"

on:
  schedule:
    - cron: "0 4 * * *"      # Daily at 04:00 UTC
  workflow_dispatch: {}       # Manual trigger

env:
  BRANCHES: "17.0 18.0 19.0"
  REGISTRY: ghcr.io
  IMAGE_NAME: sergio-bershadsky/odoo

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.check.outputs.matrix }}
    steps:
      - name: Detect new Odoo nightly releases
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          INCLUDES='[]'

          # Get a ghcr.io token to check existing tags
          GHCR_TOKEN=$(curl -sf \
            -u "_:${GH_TOKEN}" \
            "https://ghcr.io/token?scope=repository:${IMAGE_NAME}:pull" \
            | jq -r '.token' || true)

          for BRANCH in $BRANCHES; do
            echo "--- ${BRANCH} ---"

            # Fetch the official Dockerfile from odoo/docker to get ODOO_RELEASE
            DOCKERFILE=$(curl -sf \
              "https://raw.githubusercontent.com/odoo/docker/master/${BRANCH}/Dockerfile" || true)

            if [ -z "$DOCKERFILE" ]; then
              echo "  No Dockerfile at odoo/docker/${BRANCH}, skipping"
              continue
            fi

            # Parse ODOO_RELEASE (nightly date, e.g. 20260217) and ODOO_SHA
            ODOO_RELEASE=$(echo "$DOCKERFILE" | grep -oP '(?<=ARG ODOO_RELEASE=)\S+' || true)
            ODOO_SHA=$(echo "$DOCKERFILE" | grep -oP '(?<=ARG ODOO_SHA=)\S+' | head -c 7 || true)

            if [ -z "$ODOO_RELEASE" ]; then
              echo "  Could not parse ODOO_RELEASE, skipping"
              continue
            fi

            IMAGE_TAG="${BRANCH}-${ODOO_RELEASE}"
            echo "  Official nightly: ${ODOO_RELEASE} (sha: ${ODOO_SHA})"

            # Check if we already built this tag
            TAG_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${GHCR_TOKEN}" \
              "https://${REGISTRY}/v2/${IMAGE_NAME}/manifests/${IMAGE_TAG}" 2>/dev/null || echo "000")

            if [ "$TAG_STATUS" = "200" ]; then
              echo "  Already built: ${IMAGE_TAG}, skipping"
              continue
            fi

            echo "  New build needed: ${IMAGE_TAG}"
            INCLUDES=$(echo "$INCLUDES" | jq -c \
              --arg branch "$BRANCH" \
              --arg tag "$IMAGE_TAG" \
              --arg sha "$ODOO_SHA" \
              --arg release "$ODOO_RELEASE" \
              '. + [{"branch": $branch, "image_tag": $tag, "sha": $sha, "release": $release}]')
          done

          echo "matrix={\"include\":${INCLUDES}}" >> "$GITHUB_OUTPUT"
          echo "=== Matrix: ${INCLUDES}"

  build-push:
    needs: detect
    if: ${{ fromJson(needs.detect.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    permissions:
      contents: read
      packages: write
      id-token: write         # cosign keyless signing via OIDC

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ matrix.image_tag }}
            type=raw,value=${{ matrix.branch }}
          labels: |
            org.opencontainers.image.title=Odoo ${{ matrix.branch }}
            org.opencontainers.image.description=Odoo ${{ matrix.branch }} with OCA addons (nightly ${{ matrix.release }})
            org.opencontainers.image.version=${{ matrix.image_tag }}
            org.opencontainers.image.vendor=sergio-bershadsky
            org.opencontainers.image.licenses=LGPL-3.0-or-later
            org.opencontainers.image.base.name=docker.io/library/odoo:${{ matrix.branch }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./odoo
          build-args: |
            ODOO_VERSION=${{ matrix.branch }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          sbom: true
          provenance: mode=max
          cache-from: type=gha,scope=odoo-${{ matrix.branch }}
          cache-to: type=gha,scope=odoo-${{ matrix.branch }},mode=max

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          cosign sign --yes "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST}"

      - name: Scan for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.image_tag }}
          format: table
          severity: CRITICAL,HIGH
          exit-code: 0          # Don't fail the build; report only

  update-tags:
    needs: [detect, build-push]
    if: always() && needs.detect.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate TAGS.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get ghcr.io token
          TOKEN=$(curl -sf \
            -u "_:${GH_TOKEN}" \
            "https://ghcr.io/token?scope=repository:${IMAGE_NAME}:pull" \
            | jq -r '.token')

          # Fetch all tags (filter out attestation artifacts)
          TAGS=$(curl -sf \
            -H "Authorization: Bearer ${TOKEN}" \
            "https://ghcr.io/v2/${IMAGE_NAME}/tags/list?n=1000" \
            | jq -r '.tags[]' \
            | grep -vE '^sha256-' \
            | sort -V)

          # Generate TAGS.md
          {
            echo "# Available Tags"
            echo ""
            echo "> Auto-generated by CI. Do not edit manually."
            echo ">"
            echo "> Image: \`ghcr.io/sergio-bershadsky/odoo\`"
            echo ">"
            echo "> Updated: $(date -u '+%Y-%m-%d')"
            echo ""

            for BRANCH in $BRANCHES; do
              echo "## ${BRANCH}"
              echo ""

              # Rolling tag
              if echo "$TAGS" | grep -qx "$BRANCH"; then
                echo "- \`${BRANCH}\` *(rolling â€” latest build)*"
              fi

              # Dated tags (newest first)
              echo "$TAGS" | grep "^${BRANCH}-" | sort -rV | while read -r TAG; do
                echo "- \`${TAG}\`"
              done

              echo ""
            done
          } > odoo/TAGS.md

          echo "=== Generated odoo/TAGS.md ==="
          cat odoo/TAGS.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add odoo/TAGS.md
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "docs(odoo): update TAGS.md"
          git push
